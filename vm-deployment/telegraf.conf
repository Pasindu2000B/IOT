# Telegraf Configuration for VM
# Forwards data from VM InfluxDB to PC InfluxDB

[agent]
  interval = "10s"
  round_interval = true
  metric_batch_size = 100
  metric_buffer_limit = 1000
  flush_interval = "10s"

# INPUT: Read from VM InfluxDB
[[inputs.influxdb_v2_listener]]
  service_address = ":8086"
  token = "GO7pQ79-Vo-k6uwpQrMmJmITzLRHxyrFbFDrnRbz8PgZbLHKe5hpwNZCWi6Z_zolPRjn7jUQ6irQk-BPe3LK9Q=="
  org = "Ruhuna_Eng"
  bucket = "New_Sensor"

# OUTPUT: Forward to PC InfluxDB
# OPTION 1: Use Tailscale VPN (recommended - permanent IP)
#   Install Tailscale on both PC and VM: https://tailscale.com/download
#   Use Tailscale IP (e.g., 100.x.x.x) - never changes
[[outputs.influxdb_v2]]
  urls = ["http://YOUR_TAILSCALE_IP:8086"]  # e.g., http://100.64.0.1:8086
  token = "GO7pQ79-Vo-k6uwpQrMmJmITzLRHxyrFbFDrnRbz8PgZbLHKe5hpwNZCWi6Z_zolPRjn7jUQ6irQk-BPe3LK9Q=="
  organization = "Ruhuna_Eng"
  bucket = "New_Sensor"
  timeout = "5s"

# OPTION 2: Use Cloudflare Tunnel (if PC is behind NAT)
#   Run on PC: cloudflared tunnel --url http://localhost:8086
#   Use tunnel URL: https://xyz.trycloudflare.com
# [[outputs.http]]
#   url = "https://your-tunnel-url.trycloudflare.com/api/v2/write?org=Ruhuna_Eng&bucket=New_Sensor"
#   method = "POST"
#   headers = { "Authorization" = "Token GO7pQ79-Vo-k6uwpQrMmJmITzLRHxyrFbFDrnRbz8PgZbLHKe5hpwNZCWi6Z_zolPRjn7jUQ6irQk-BPe3LK9Q==" }
#   data_format = "influx"
  
# MQTT Input (alternative if sensors send directly to MQTT)
[[inputs.mqtt_consumer]]
  servers = ["tcp://mosquitto:1883"]
  topics = ["machine_sensor_data"]
  data_format = "json"
  json_time_key = "timestamp"
  json_time_format = "unix"
