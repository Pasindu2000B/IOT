version: '3.8'

services:
  # FastAPI Dashboard - Serves predictions via public IP
  dashboard:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: iot-dashboard
    ports:
      - "80:8000"      # Map port 80 (HTTP) to container port 8000
      - "8000:8000"    # Also expose 8000 directly
    environment:
      # InfluxDB connection - points to VM's local InfluxDB
      INFLUX_TOKEN: "GO7pQ79-Vo-k6uwpQrMmJmITzLRHxyrFbFDrnRbz8PgZbLHKe5hpwNZCWi6Z_zolPRjn7jUQ6irQk-BPe3LK9Q=="
      INFLUX_URL: "http://influxdb:8086"
      INFLUX_ORG: "Ruhuna_Eng"
      INFLUX_BUCKET: "New_Sensor"
    volumes:
      - ./models:/app/models
      - ./static:/app/static
    depends_on:
      - influxdb
    restart: always
    mem_limit: 512m
    networks:
      - iot-network

  # InfluxDB - Data storage
  influxdb:
    image: influxdb:2.7-alpine
    container_name: vm-influxdb
    ports:
      - "8086:8086"
    volumes:
      - ./influxdb-data:/var/lib/influxdb2
    environment:
      DOCKER_INFLUXDB_INIT_MODE: setup
      DOCKER_INFLUXDB_INIT_USERNAME: "Pasindu Bimsara"
      DOCKER_INFLUXDB_INIT_PASSWORD: abcdefgh
      DOCKER_INFLUXDB_INIT_ORG: Ruhuna_Eng
      DOCKER_INFLUXDB_INIT_BUCKET: New_Sensor
      DOCKER_INFLUXDB_INIT_ADMIN_TOKEN: "GO7pQ79-Vo-k6uwpQrMmJmITzLRHxyrFbFDrnRbz8PgZbLHKe5hpwNZCWi6Z_zolPRjn7jUQ6irQk-BPe3LK9Q=="
    restart: always
    mem_limit: 256m
    networks:
      - iot-network

  # MQTT Broker - Receives sensor data
  mosquitto:
    image: eclipse-mosquitto:2.0
    container_name: vm-mosquitto
    ports:
      - "1883:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
      - ./mqtt-data:/mosquitto/data
      - ./mqtt-log:/mosquitto/log
    restart: always
    mem_limit: 64m
    networks:
      - iot-network

  # Telegraf - MQTT to InfluxDB bridge
  telegraf:
    image: telegraf:alpine
    container_name: vm-telegraf
    volumes:
      - ./telegraf.conf:/etc/telegraf/telegraf.conf:ro
    depends_on:
      - mosquitto
      - influxdb
    restart: always
    mem_limit: 64m
    networks:
      - iot-network

networks:
  iot-network:
    driver: bridge
